<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Camcookie Play Conect - Bus Garage</title>
  <style>
    body{font-family:Arial,sans-serif;margin:0;padding:20px;
      background:linear-gradient(-45deg,#ff9a9e,#fad0c4,#a1c4fd,#c2e9fb);
      background-size:400% 400%;animation:bg 12s ease infinite;color:#333;
      overflow-x:hidden;}
    @keyframes bg{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    header{text-align:center;margin-bottom:20px;}h1{margin:0;}
    .container{max-width:600px;margin:auto;}
    .box{background:#fff;padding:20px;margin-bottom:20px;
      border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
    label,input,textarea,button{display:block;width:100%;margin:8px 0;}
    input,textarea{padding:8px;border:1px solid #ccc;border-radius:4px;
      box-sizing:border-box;font-size:1rem;}
    button{padding:10px;font-size:1rem;font-weight:bold;border:none;
      border-radius:4px;background:#0078d4;color:#fff;cursor:pointer;}
    button:hover{background:#005a9e;}button.danger{background:#d9534f;}
    ul{list-style:none;padding:0;}ul li{padding:10px 0;border-bottom:1px solid #ddd;}
    .hidden{display:none;} .error{color:#d9534f;}
    #offlineOverlay{
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.8);color:#fff;
      display:flex;align-items:center;justify-content:center;
      font-size:1.5rem;z-index:9999;display:none;
    }
    .disabled *{pointer-events:none;opacity:0.5;}
  </style>
</head>
<body>
  <div id="offlineOverlay">You are offline. Please reconnect.</div>
  <header><h1>Camcookie Play Conect - Bus Garage</h1></header>
  <div class="container">

    <!-- STEP 1: Parent session code -->
    <div id="connectBox" class="box">
      <h2>Enter Parent Session Code</h2>
      <p>Get the 8-character code from your parent.</p>
      <input id="sessionCode" placeholder="Session Code">
      <button onclick="connect()">Connect</button>
      <p id="connectError" class="error"></p>
      <p><a href="parent.html">Parent Dashboard</a></p>
    </div>

    <!-- STEP 2: Bus name & stops -->
    <div id="mainUI" class="hidden">
      <div class="box">
        <h2>Bus Name</h2>
        <input id="busNameInput" placeholder="Enter bus name">
        <button onclick="updateBusName()">Update Bus Name</button>
      </div>

      <div class="box">
        <h2>Manage Bus Stops</h2>
        <form id="stopForm">
          <label>Code</label>
          <input name="code" placeholder="e.g. A1" required>
          <label>Name</label>
          <input name="name" placeholder="e.g. Main Street" required>
          <label>Times (comma-separated)</label>
          <input name="times" placeholder="e.g. 8:00 AM, 2:30 PM" required>
          <label>Description</label>
          <textarea name="desc" placeholder="Add fun notes"></textarea>
          <button type="submit">Save Stop</button>
          <button type="button" class="danger" onclick="clearAll()">
            Clear All Stops
          </button>
        </form>
        <h3>Existing Stops</h3>
        <ul id="stopList"></ul>
        <button onclick="disconnect()">Disconnect</button>
      </div>
    </div>

  </div>
  <script>
  // OFFLINE DETECTION
  const overlay = document.getElementById("offlineOverlay");
  function goOffline(){ overlay.style.display="flex"; document.body.classList.add("disabled"); }
  function goOnline(){ overlay.style.display="none"; document.body.classList.remove("disabled"); }
  window.addEventListener("offline",goOffline);
  window.addEventListener("online",goOnline);
  if(!navigator.onLine) goOffline();

  // GitHubStorage Helper
  const GH = {
    owner:"YOUR_GH_USERNAME", repo:"bus-stop-funtime", branch:"main",
    token:null, expires:0,
    init(owner,repo,pat,branch="main"){
      this.owner=owner; this.repo=repo; this.branch=branch;
      this.token=pat; this.expires=Date.now()+5*60e3;
      setTimeout(()=>this.token=null,5*60e3+1000);
    },
    async fetchData(){
      if(!navigator.onLine) throw "Offline";
      if(!this.token||Date.now()>this.expires) throw "Session expired";
      const url = `https://api.github.com/repos/${this.owner}/${this.repo}`+
                  `/contents/data.json?ref=${this.branch}`;
      const res = await fetch(url,{
        headers:{ Authorization:`token ${this.token}` }
      });
      if(!res.ok) throw await res.text();
      const {content,sha} = await res.json();
      return { data:JSON.parse(atob(content)), sha };
    },
    async saveData(newData, sha){
      if(!navigator.onLine) throw "Offline";
      if(!this.token||Date.now()>this.expires) throw "Session expired";
      const url = `https://api.github.com/repos/${this.owner}/${this.repo}`+
                  `/contents/data.json`;
      const body = {
        message:"Update via Camcookie Play Conect",
        branch:this.branch,
        content:btoa(JSON.stringify(newData,null,2)),
        sha
      };
      const res = await fetch(url,{
        method:"PUT",
        headers:{
          Authorization:`token ${this.token}`,
          "Content-Type":"application/json"
        },
        body:JSON.stringify(body)
      });
      if(!res.ok) throw await res.text();
      return await res.json();
    }
  };

  // Utilities
  const esc = s => s.replace(/&/g,"&amp;")
                    .replace(/</g,"&lt;")
                    .replace(/>/g,"&gt;");
  const banned = ["stupid","idiot","hate","kill"];
  const hasBully = s => banned.some(w=>s.toLowerCase().includes(w));

  let currentSHA = "", editIdx = null;
  const FREE_MAX_STOPS = 5;

  // 1) Connect via parent session code
  async function connect(){
    if(!navigator.onLine){ alert("Offline"); return; }
    const code = document.getElementById("sessionCode").value.trim();
    const err  = document.getElementById("connectError");
    err.textContent = "";
    if(!code){ err.textContent="Enter the session code"; return; }
    try {
      // dummy init to read sessions
      GH.init(GH.owner, GH.repo, "fake", GH.branch);
      const { data, sha } = await GH.fetchData();
      if(!data.sessions[code]){
        err.textContent="Invalid code"; return;
      }
      // real init with parent's PAT
      const parentPAT = data.sessions[code].token;
      GH.init(GH.owner, GH.repo, parentPAT, GH.branch);
      currentSHA = sha;
      document.getElementById("connectBox").classList.add("hidden");
      document.getElementById("mainUI").classList.remove("hidden");
      renderAll();
    } catch(e){
      err.textContent = e.toString();
    }
  }

  // 2) Render busName + stops
  async function renderAll(){
    const { data, sha } = await GH.fetchData();
    currentSHA = sha;
    document.getElementById("busNameInput").value = data.busName || "";
    const ul = document.getElementById("stopList");
    ul.innerHTML = "";
    if(!data.stops.length){
      ul.innerHTML = "<li>No stops yet</li>"; return;
    }
    data.stops.forEach((s,i)=>{
      const li = document.createElement("li");
      li.innerHTML = `
        <strong>${esc(s.code)}</strong> â€“ ${esc(s.name)}<br>
        Times: ${s.times.map(esc).join(", ")}<br>
        ${esc(s.desc)}<br>
        <button onclick="startEdit(${i})">Edit</button>
        <button onclick="deleteStop(${i})">Delete</button>
      `;
      ul.appendChild(li);
    });
  }

  // Update bus name
  async function updateBusName(){
    if(!navigator.onLine){ alert("Offline"); return; }
    const name = document.getElementById("busNameInput").value.trim();
    if(!name){ alert("Enter a bus name"); return; }
    const { data } = await GH.fetchData();
    data.busName = name;
    const save = await GH.saveData(data, currentSHA);
    currentSHA = save.content.sha;
    alert("Bus name updated");
  }

  // Handle stop form
  document.getElementById("stopForm")
    .addEventListener("submit", async e => {
      e.preventDefault();
      if(!navigator.onLine){ alert("Offline"); return; }
      const f     = e.target;
      const code  = f.code.value.trim();
      const name  = f.name.value.trim();
      const times = f.times.value.split(",").map(t=>t.trim()).filter(Boolean);
      const desc  = f.desc.value.trim();
      if(!code||!name||!times.length)
        return alert("Code, name & at least one time required");
      if(hasBully(code+name+desc))
        return alert("Please avoid unkind words");

      const { data } = await GH.fetchData();

      // Enforce free-tier stop limit
      if(editIdx == null && !data.plusActive && data.stops.length >= FREE_MAX_STOPS){
        return alert(
          `Free tier limit of ${FREE_MAX_STOPS} stops reached.\n`+
          `Upgrade to Plus to add more.`
        );
      }

      if(editIdx != null){
        data.stops[editIdx] = { code,name,times,desc };
        editIdx = null;
      } else {
        data.stops.push({ code,name,times,desc });
      }
      const save = await GH.saveData(data, currentSHA);
      currentSHA = save.content.sha;
      f.reset(); renderAll();
    });

  function startEdit(i){
    GH.fetchData().then(({ data })=>{
      const s = data.stops[i], f = document.getElementById("stopForm");
      f.code.value  = s.code;
      f.name.value  = s.name;
      f.times.value = s.times.join(", ");
      f.desc.value  = s.desc;
      editIdx = i;
    });
  }

  async function deleteStop(i){
    if(!navigator.onLine){ alert("Offline"); return; }
    if(!confirm("Remove this stop?")) return;
    const { data } = await GH.fetchData();
    data.stops.splice(i,1);
    const save = await GH.saveData(data, currentSHA);
    currentSHA = save.content.sha;
    renderAll();
  }

  async function clearAll(){
    if(!navigator.onLine){ alert("Offline"); return; }
    if(!confirm("Wipe all stops?")) return;
    const { data } = await GH.fetchData();
    data.stops = [];
    const save = await GH.saveData(data, currentSHA);
    currentSHA = save.content.sha;
    renderAll();
  }

  function disconnect(){ location.reload(); }
  </script>
</body>
</html>