<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Camcookie Play Conect - Parent Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 20px;
      background: linear-gradient(-45deg,#fad0c4,#ffd194,#ace0f9,#bee7e8);
      background-size: 400% 400%;
      animation: bg 20s ease infinite;
      color: #333;
    }
    @keyframes bg {
      0%   { background-position:0%   50%; }
      50%  { background-position:100% 50%; }
      100% { background-position:0%   50%; }
    }
    .container {
      max-width: 700px;
      margin: auto;
    }
    .box {
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    label, input, button {
      display: block;
      width: 100%;
      margin: 8px 0;
    }
    input {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    button {
      padding: 10px;
      font-size: 1rem;
      font-weight: bold;
      border: none;
      border-radius: 4px;
      background: #0078d4;
      color: #fff;
      cursor: pointer;
    }
    button:hover {
      background: #005a9e;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #f7f7f7;
    }
    .hidden {
      display: none;
    }
    #offlineOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      z-index: 9999;
      display: none;
    }
    .disabled * {
      pointer-events: none;
      opacity: 0.5;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
</head>
<body>
  <div id="offlineOverlay">You are offline. Please reconnect.</div>
  <div class="container">
    <!-- Authentication -->
    <div id="auth" class="box">
      <h2>Login / Register</h2>
      <form id="loginForm">
        <input name="user" placeholder="Username" required>
        <input name="pass" type="password" placeholder="Password" required>
        <button type="submit">Login</button>
      </form>
      <hr>
      <form id="regForm">
        <input name="user" placeholder="New username" required>
        <input name="pass" type="password" placeholder="New password" required>
        <button type="submit">Register</button>
      </form>
    </div>

    <!-- Dashboard -->
    <div id="dash" class="hidden">
      <!-- GitHub PAT -->
      <div class="box">
        <h2>GitHub Personal Access Token</h2>
        <p>Enter a PAT (repo scope). Valid for 5 minutes.</p>
        <input id="pat" type="password" placeholder="GitHub PAT">
        <button id="connectPat">Connect</button>
      </div>

      <!-- Controls -->
      <div id="controls" class="hidden">

        <!-- Plus Subscription -->
        <div class="box">
          <h2>Plus Subscription</h2>
          <p>Free tier: up to 5 stops, 1 session code.</p>
          <p><a href="https://paypal.me/yourlink" target="_blank">
            <button>Buy Plus</button>
          </a></p>
          <button id="plusBtn">Toggle Plus</button>
        </div>

        <!-- Session Expiry -->
        <div class="box">
          <h2>Kid Session Expiry</h2>
          <p>Require re-entry if closed longer than:</p>
          <input id="expiryInput" type="number" min="1" placeholder="Minutes">
          <button id="updateExpiry">Update Expiry</button>
        </div>

        <!-- Bus Name -->
        <div class="box">
          <h2>Bus Name</h2>
          <input id="busNameInput" placeholder="Enter bus name">
          <button id="updateBusName">Update Bus Name</button>
        </div>

        <!-- Stops Table -->
        <div class="box">
          <h2>All Stops</h2>
          <button id="refreshStops">Refresh Stops</button>
          <table>
            <thead>
              <tr>
                <th>Code</th>
                <th>Name</th>
                <th>Times</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody id="stopsTable"></tbody>
          </table>
        </div>

        <!-- Sessions Table -->
        <div class="box">
          <h2>Kid Session Codes</h2>
          <button id="refreshSessions">Refresh Codes</button>
          <button id="genSession">Create Code</button>
          <table>
            <thead>
              <tr>
                <th>Code</th>
                <th>Created</th>
                <th>Revoke</th>
              </tr>
            </thead>
            <tbody id="sessTable"></tbody>
          </table>
        </div>

        <button id="logoutBtn">Logout</button>
      </div>
    </div>
  </div>

  <script>
  // OFFLINE HANDLING
  const offlineOverlay = document.getElementById("offlineOverlay");
  window.addEventListener("offline", () => {
    offlineOverlay.style.display = "flex";
    document.body.classList.add("disabled");
  });
  window.addEventListener("online", () => {
    offlineOverlay.style.display = "none";
    document.body.classList.remove("disabled");
  });
  if (!navigator.onLine) {
    offlineOverlay.style.display = "flex";
    document.body.classList.add("disabled");
  }

  // RAW JSON for config & free-tier reads
  const RAW_URL = 
    "https://raw.githubusercontent.com/camcookie876/bus-stop-funtime/main/data.json";
  async function fetchRaw() {
    const r = await fetch(RAW_URL);
    if (!r.ok) throw "Unable to load config";
    return r.json();
  }

  // GITHUB API helper
  const GH = {
    owner: "camcookie876",
    repo: "bus-stop-funtime",
    branch: "main",
    token: null,
    expires: 0,
    init(pat) {
      this.token = pat;
      this.expires = Date.now() + 5 * 60e3;
      setTimeout(() => this.token = null, 5 * 60e3 + 500);
    },
    async fetchData() {
      if (!navigator.onLine) throw "Offline";
      if (!this.token || Date.now() > this.expires) 
        throw "Session expired";
      const url = `https://api.github.com/repos/${this.owner}/${this.repo}`
                + `/contents/data.json?ref=${this.branch}`;
      const r = await fetch(url, {
        headers: { Authorization: `token ${this.token}` }
      });
      if (!r.ok) throw await r.text();
      const j = await r.json();
      return {
        data: JSON.parse(atob(j.content)),
        sha: j.sha
      };
    },
    async saveData(newData, sha) {
      if (!navigator.onLine) throw "Offline";
      if (!this.token || Date.now() > this.expires) 
        throw "Session expired";
      const url = `https://api.github.com/repos/${this.owner}/${this.repo}`
                + `/contents/data.json`;
      const body = {
        message: "Update via Camcookie Play Conect",
        branch: this.branch,
        content: btoa(JSON.stringify(newData, null, 2)),
        sha
      };
      const r = await fetch(url, {
        method: "PUT",
        headers: {
          Authorization: `token ${this.token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });
      if (!r.ok) throw await r.text();
      return r.json();
    }
  };

  // Simple HTML escaper
  function esc(s) {
    return s.replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
  }

  // Local parent store
  const PKEY = "busParents";
  function getParents() {
    return JSON.parse(localStorage.getItem(PKEY) || "{}");
  }
  function saveParents(p) {
    localStorage.setItem(PKEY, JSON.stringify(p));
  }

  // Auth forms
  document.getElementById("regForm")
    .addEventListener("submit", async e => {
      e.preventDefault();
      const f = e.target, u = f.user.value.trim(), p = f.pass.value;
      const parents = getParents();
      if (parents[u]) return alert("Username taken");
      bcrypt.hash(p, 10, (_, h) => {
        parents[u] = h;
        saveParents(parents);
        alert("Registered. Please log in.");
        f.reset();
      });
    });

  document.getElementById("loginForm")
    .addEventListener("submit", (e) => {
      e.preventDefault();
      const f = e.target, u = f.user.value.trim(), p = f.pass.value;
      const parents = getParents();
      if (!parents[u]) return alert("No such user");
      bcrypt.compare(p, parents[u], (err, ok) => {
        if (!ok) return alert("Wrong password");
        document.getElementById("auth").classList.add("hidden");
        document.getElementById("dash").classList.remove("hidden");
      });
    });

  // After login: Connect PAT
  document.getElementById("connectPat")
    .addEventListener("click", async () => {
      const pat = document.getElementById("pat").value.trim();
      if (!pat) return alert("Enter a PAT");
      GH.init(pat);
      document.getElementById("controls").classList.remove("hidden");
      await refreshUI();
    });

  // Refresh UI with current data
  async function refreshUI() {
    const raw = await fetchRaw();
    // Plus toggle
    document.getElementById("plusBtn").textContent =
      raw.plusActive ? "Disable Plus" : "Enable Plus";
    // Expiry input (minutes)
    document.getElementById("expiryInput").value =
      Math.round((raw.config?.kidExpiry || 600000) / 60000);
    // Bus name
    const { data } = await GH.fetchData();
    document.getElementById("busNameInput").value = data.busName || "";
  }

  // Plus toggle
  document.getElementById("plusBtn")
    .addEventListener("click", async () => {
      const { data, sha } = await GH.fetchData();
      data.plusActive = !data.plusActive;
      await GH.saveData(data, sha);
      await refreshUI();
      alert("Plus is now " + (data.plusActive ? "ENABLED" : "DISABLED"));
    });

  // Update kid expiry
  document.getElementById("updateExpiry")
    .addEventListener("click", async () => {
      const mins = parseInt(
        document.getElementById("expiryInput").value, 10
      );
      if (isNaN(mins) || mins < 1)
        return alert("Enter minutes ≥ 1");
      const ms = mins * 60000;
      const { data, sha } = await GH.fetchData();
      data.config = data.config || {};
      data.config.kidExpiry = ms;
      await GH.saveData(data, sha);
      alert(`Session expiry set to ${mins} minute(s)`);
    });

  // Update bus name
  document.getElementById("updateBusName")
    .addEventListener("click", async () => {
      const name = document.getElementById("busNameInput").value.trim();
      if (!name) return alert("Enter a bus name");
      const { data, sha } = await GH.fetchData();
      data.busName = name;
      await GH.saveData(data, sha);
      alert("Bus name updated");
    });

  // Refresh stops
  document.getElementById("refreshStops")
    .addEventListener("click", async () => {
      const { data } = await GH.fetchData();
      const tb = document.getElementById("stopsTable");
      tb.innerHTML = "";
      data.stops.forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(s.code)}</td>
          <td>${esc(s.name)}</td>
          <td>${esc(s.times.join(", "))}</td>
          <td>${esc(s.desc)}</td>
        `;
        tb.appendChild(tr);
      });
    });

  // Session code generator
  function rndCode() {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    let c = "";
    for (let i = 0; i < 8; i++) {
      c += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return c;
  }

  // Refresh session codes
  document.getElementById("refreshSessions")
    .addEventListener("click", async () => {
      const raw = await fetchRaw();
      const tb = document.getElementById("sessTable");
      tb.innerHTML = "";
      for (const [code, row] of Object.entries(raw.sessions)) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(code)}</td>
          <td>${new Date(row.created).toLocaleString()}</td>
          <td>
            <button onclick="revoke('${code}')">Revoke</button>
          </td>
        `;
        tb.appendChild(tr);
      }
    });

  // Generate new session code
  document.getElementById("genSession")
    .addEventListener("click", async () => {
      const raw = await fetchRaw();
      const limit = Object.keys(raw.sessions).length;
      if (!raw.plusActive && limit >= 1) {
        return alert(
          "Free tier allows only 1 session code. Upgrade to Plus."
        );
      }
      const code = rndCode();
      const { data, sha } = await GH.fetchData();
      data.sessions = data.sessions || {};
      data.sessions[code] = {
        token: GH.token,
        created: Date.now()
      };
      await GH.saveData(data, sha);
      alert("Share this code with your child:\n\n" + code);
      document.getElementById("refreshSessions").click();
    });

  // Revoke a session code
  async function revoke(code) {
    if (!confirm(`Revoke session “${code}”?`)) return;
    const { data, sha } = await GH.fetchData();
    delete data.sessions[code];
    await GH.saveData(data, sha);
    document.getElementById("refreshSessions").click();
  }

  // Logout
  document.getElementById("logoutBtn")
    .addEventListener("click", () => {
      location.reload();
    });
  </script>
</body>
</html>